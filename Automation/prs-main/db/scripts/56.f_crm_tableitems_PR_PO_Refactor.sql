--Purpose : Period Contract Tables

/* ----------------------------------------------------------------------
TABLE: PRS_PURCHASE_EXCHANGERATE (New Table)
---------------------------------------------------------------------- */

CREATE TABLE PRSDBM.PRS_PURCHASE_EXCHANGERATE (
    EXCH_N        VARCHAR2(11) NOT NULL,
    PR_N          VARCHAR2(11) NOT NULL,
    CRCY_C        VARCHAR2(4) NOT NULL,
    EXCH_A        NUMBER NOT NULL,
    FIN_UPD_DTM   DATE NOT NULL
)
TABLESPACE PRS_DAT;

COMMENT ON TABLE PRSDBM.PRS_PURCHASE_EXCHANGERATE IS
    'This table stores the exchange rates used in the respective purchase requests.';

COMMENT ON COLUMN PRSDBM.PRS_PURCHASE_EXCHANGERATE.EXCH_N IS
    'Primary key. Populated by Oracle Sequence.';

COMMENT ON COLUMN PRSDBM.PRS_PURCHASE_EXCHANGERATE.PR_N IS
    'Reference to the Purchase Request.';

COMMENT ON COLUMN PRSDBM.PRS_PURCHASE_EXCHANGERATE.CRCY_C IS
    'Currency code for the exchange rate.';

COMMENT ON COLUMN PRSDBM.PRS_PURCHASE_EXCHANGERATE.EXCH_A IS
    'Exchange rate.';

COMMENT ON COLUMN PRSDBM.PRS_PURCHASE_EXCHANGERATE.FIN_UPD_DTM IS
    'Date exchange rate was updated in SAP Finance.';

/* ----------------------------------------------------------------------
CONSTRAINT:  Format is SYSTEM_TABLE_KEY_COL(S)
KEY Type: PK (Primary Key), FK (Foreign Key), UK (Unique Key), CK (Constraint), I (INDEX)
---------------------------------------------------------------------- */
ALTER TABLE PRSDBM.PRS_PURCHASE_EXCHANGERATE ADD CONSTRAINT PRS_PER_PK_PN PRIMARY KEY ( EXCH_N )
  USING INDEX TABLESPACE PRS_IDX;

ALTER TABLE PRSDBM.PRS_PURCHASE_EXCHANGERATE
    ADD CONSTRAINT PRS_PER_FK_CC FOREIGN KEY ( CRCY_C )
        REFERENCES PRSDBM.PRSCURRENCY ( CRCY_C );

ALTER TABLE PRSDBM.PRS_PURCHASE_EXCHANGERATE
    ADD CONSTRAINT PRS_PER_FK_PN FOREIGN KEY ( PR_N )
        REFERENCES PRSDBM.PRS_PURCHASE_REQ ( PR_N );


/* ----------------------------------------------------------------------
TABLE: PRS_PURCHASE_INTERNALSTORE (New Table)
---------------------------------------------------------------------- */
CREATE TABLE PRSDBM.PRS_PURCHASE_INTERNALSTORE (
    INTL_PURCH_N   VARCHAR2(11) NOT NULL,
    INTL_STORE_N   VARCHAR2(11) NOT NULL,
    PR_N           VARCHAR2(11) NOT NULL
)
TABLESPACE PRS_DAT;

COMMENT ON TABLE PRSDBM.PRS_PURCHASE_INTERNALSTORE IS
    'This table maps the relevant  purchase requests to the respective internal stores.';

COMMENT ON COLUMN PRSDBM.PRS_PURCHASE_INTERNALSTORE.INTL_PURCH_N IS
    'Primary key. Generated by Oracle sequence.';

COMMENT ON COLUMN PRSDBM.PRS_PURCHASE_INTERNALSTORE.INTL_STORE_N IS
    'Reference to the internal store.';

COMMENT ON COLUMN PRSDBM.PRS_PURCHASE_INTERNALSTORE.PR_N IS
    'Reference to the purchase request.';

/* ----------------------------------------------------------------------
CONSTRAINT:  Format is SYSTEM_TABLE_KEY_COL(S)
KEY Type: PK (Primary Key), FK (Foreign Key), UK (Unique Key), CK (Constraint), I (INDEX)
---------------------------------------------------------------------- */

ALTER TABLE PRSDBM.PRS_PURCHASE_INTERNALSTORE ADD CONSTRAINT PRS_PIS_PK_ISN PRIMARY KEY ( INTL_PURCH_N )
  USING INDEX TABLESPACE PRS_IDX;

ALTER TABLE PRSDBM.PRS_PURCHASE_INTERNALSTORE
    ADD CONSTRAINT PRS_PIS_FK_ISN FOREIGN KEY ( INTL_STORE_N )
        REFERENCES PRSDBM.PRS_INTERNAL_STORE ( INTL_STORE_N );

ALTER TABLE PRSDBM.PRS_PURCHASE_INTERNALSTORE
    ADD CONSTRAINT PRS_PIS_FK_PN FOREIGN KEY ( PR_N )
        REFERENCES PRSDBM.PRS_PURCHASE_REQ ( PR_N );


/* ----------------------------------------------------------------------
TABLE: PRS_DELVORDER_INFO (New Column)
---------------------------------------------------------------------- */

ALTER TABLE PRSDBM.PRS_DELVORDER_INFO
  ADD QT_N VARCHAR2(11);

COMMENT ON COLUMN PRSDBM.PRS_DELVORDER_INFO.QT_N IS
  'Reference to the quotation this delivery order information record is for.';

ALTER TABLE PRSDBM.PRS_DELVORDER_INFO
    ADD CONSTRAINT PRS_PDI_FK_QN FOREIGN KEY ( QT_N )
        REFERENCES PRSDBM.PRS_QUOTATION ( QT_N );

/* ----------------------------------------------------------------------
TABLE: PRS_PURCHASE_LINEITEM (New Columns)
---------------------------------------------------------------------- */

ALTER TABLE PRSDBM.PRS_PURCHASE_LINEITEM
  ADD CRCY_C VARCHAR2(4);

ALTER TABLE PRSDBM.PRS_PURCHASE_LINEITEM
  ADD QT_N VARCHAR2(11);

ALTER TABLE PRSDBM.PRS_PURCHASE_LINEITEM
  ADD CON_N VARCHAR2(20);

COMMENT ON COLUMN PRSDBM.PRS_PURCHASE_LINEITEM.CRCY_C IS
  'Currency code for the unit price and subtotal.';

COMMENT ON COLUMN PRSDBM.PRS_PURCHASE_LINEITEM.QT_N IS
  'Reference to the quotation this line item belongs to.';

COMMENT ON COLUMN PRSDBM.PRS_PURCHASE_LINEITEM.CON_N IS
  'Stores the period contract number if this line item was purchase under a period contract.';

ALTER TABLE PRSDBM.PRS_PURCHASE_LINEITEM
    ADD CONSTRAINT PRS_PPL_FK_CC FOREIGN KEY ( CRCY_C )
        REFERENCES PRSDBM.PRSCURRENCY ( CRCY_C );

ALTER TABLE PRSDBM.PRS_PURCHASE_LINEITEM
    ADD CONSTRAINT PRS_PPL_FK_QN FOREIGN KEY ( QT_N )
        REFERENCES PRSDBM.PRS_QUOTATION ( QT_N );

/* ----------------------------------------------------------------------
SEQUENCE
---------------------------------------------------------------------- */
CREATE SEQUENCE PRSDBM.PRS_PURCHASE_EXCHANGERATE_SEQ START WITH 1 MINVALUE 1 NOCACHE ORDER ;
CREATE SEQUENCE PRSDBM.PRS_PURCHASE_INTERNALSTORE_SEQ START WITH 1 MINVALUE 1 NOCACHE ORDER ;

/* ----------------------------------------------------------------------
GRANTS
---------------------------------------------------------------------- */
GRANT DELETE, INSERT, SELECT, UPDATE ON PRSDBM.PRS_PERIODCONTRACT_PARTICS TO PRJPRS;
GRANT SELECT ON PRSDBM.PRS_PERIODCONTRACT_PARTICS TO RPTPRS;
GRANT DELETE, INSERT, SELECT, UPDATE ON PRSDBM.PRS_PURCHASE_INTERNALSTORE TO PRJPRS;
GRANT SELECT ON PRSDBM.PRS_PURCHASE_INTERNALSTORE TO RPTPRS;

GRANT SELECT ON PRSDBM.PRS_CONTRACT_PRD_SEQ TO PRJPRS;
GRANT SELECT ON PRSDBM.PRS_CONTRACT_PRD_SEQ TO RPTPRS;
GRANT SELECT ON PRSDBM.PRS_PURCHASE_INTERNALSTORE_SEQ TO PRJPRS;
GRANT SELECT ON PRSDBM.PRS_PURCHASE_INTERNALSTORE_SEQ TO RPTPRS;

/* ----------------------------------------------------------------------
INDEXES
---------------------------------------------------------------------- */

-- Drop unique constraint for contract number. Validation will be done at application level.
ALTER TABLE PRSDBM.PRS_PERIODCONTRACT_PARTICS DROP CONSTRAINT PRS_PCP_UN_CN UNIQUE ( CON_N ) ;

/* ----------------------------------------------------------------------
PUBLIC SYNONYM: Synonym name must be the same as the table name
---------------------------------------------------------------------- */
CREATE PUBLIC SYNONYM PRS_PURCHASE_EXCHANGERATE FOR PRSDBM.PRS_PURCHASE_EXCHANGERATE;
CREATE PUBLIC SYNONYM PRS_PURCHASE_INTERNALSTORE FOR PRSDBM.PRS_PURCHASE_INTERNALSTORE;






--Purpose : Contract Utilization tables.

/* ----------------------------------------------------------------------
TABLE: PRS_CONTRACT_UTILIZATION (New Table)
---------------------------------------------------------------------- */

CREATE TABLE PRS_CONTRACT_UTILIZATION (
    CON_UTILIZATION_N  VARCHAR2(11) NOT NULL,
    CON_N              VARCHAR2(11) NOT NULL,
    CON_UTILIZATION_A  NUMBER(10, 2) NOT NULL,
    SRCE_TP_C          VARCHAR2(11) NOT NULL,
    REC_CREATE_DTM     DATE NOT NULL
);

TABLESPACE PRS_DAT;

COMMENT ON TABLE PRSDBM.PRS_CONTRACT_UTILIZATION IS
    'This table stores the contract utilization amounts.They will be used to calculate the remaining contract values, etc..';

COMMENT ON COLUMN PRSDBM.PRS_CONTRACT_UTILIZATION.CON_UTILIZATION_N IS
    'Primary key. Populated by Oracle Sequence.';

COMMENT ON COLUMN PRSDBM.PRS_CONTRACT_UTILIZATION.CON_N IS
    'Stores the period contract number.';

COMMENT ON COLUMN PRSDBM.PRS_CONTRACT_UTILIZATION.CON_UTILIZATION_A IS
    'Contract amount utilized';

COMMENT ON COLUMN PRSDBM.PRS_CONTRACT_UTILIZATION.SRCE_TP_C IS
    'Source of the contract amount utilized. E.g: PURCHASE REQUEST, PURCHASE ORDER or COLLECTION';

COMMENT ON COLUMN PRSDBM.PRS_CONTRACT_UTILIZATION.REC_CREATE_DTM IS
    'Record created datetime.';

/* ----------------------------------------------------------------------
CONSTRAINT:  Format is SYSTEM_TABLE_KEY_COL(S)
KEY Type: PK (Primary Key), FK (Foreign Key), UK (Unique Key), CK (Constraint), I (INDEX)
---------------------------------------------------------------------- */
ALTER TABLE PRSDBM.PRS_CONTRACT_UTILIZATION ADD CONSTRAINT PRS_PCU_PK_CUN PRIMARY KEY ( CON_UTILIZATION_N )
  USING INDEX TABLESPACE PRS_IDX;

ALTER TABLE PRS_CONTRACT_UTILIZATION ADD CONSTRAINT PRS_PCU_FK_CUSC FOREIGN KEY ( SRCE_TP_C )
  REFERENCES PRSCTABLE ( CODE_C );

CREATE INDEX PRSDBM.PRS_PCU_I_CON ON PRSDBM.PRS_CONTRACT_UTILIZATION (CON_N) TABLESPACE S1_IDX; 
CREATE INDEX PRSDBM.PRS_PCU_I_STC ON PRSDBM.PRS_CONTRACT_UTILIZATION (SRCE_TP_C) TABLESPACE S1_IDX; 

/* ----------------------------------------------------------------------
TABLE: PRS_LINEITEM_CONTRACTUTIL (New Table)
---------------------------------------------------------------------- */

CREATE TABLE PRS_LINEITEM_CONTRACTUTIL (
    LINEITEM_CONTRACT_N  VARCHAR2(11) NOT NULL,
    LINEITEM_N           VARCHAR2(11) NOT NULL,
    CON_UTILIZATION_N    VARCHAR2(11) NOT NULL
);

TABLESPACE PRS_DAT;

COMMENT ON TABLE PRSDBM.PRS_LINEITEM_CONTRACTUTIL IS
    'This table maps the contract utilization amounts to the purchase request lineitem';

COMMENT ON COLUMN PRSDBM.PRS_LINEITEM_CONTRACTUTIL.LINEITEM_CONTRACT_N IS
    'Primary key. Populated by Oracle Sequence.';
COMMENT ON COLUMN PRSDBM.PRS_LINEITEM_CONTRACTUTIL.LINEITEM_N IS
    'Reference to the purchase lineitem.';
COMMENT ON COLUMN PRSDBM.PRS_LINEITEM_CONTRACTUTIL.CON_UTILIZATION_N IS
    'Reference to contract utilization.';


ALTER TABLE PRS_LINEITEM_CONTRACTUTIL ADD CONSTRAINT PRS_LIC_PK_LICN PRIMARY KEY ( LINEITEM_CONTRACT_N )
  USING INDEX TABLESPACE PRS_IDX;

ALTER TABLE PRS_LINEITEM_CONTRACTUTIL ADD CONSTRAINT PPLC_FK_CUN FOREIGN KEY ( CON_UTILIZATION_N )
  REFERENCES PRS_CONTRACT_UTILIZATION ( CON_UTILIZATION_N );

ALTER TABLE PRS_LINEITEM_CONTRACTUTIL ADD CONSTRAINT PPLC_FK_LN FOREIGN KEY ( LINEITEM_N )
  REFERENCES PRS_PURCHASE_LINEITEM ( LINEITEM_N );

CREATE INDEX PRSDBM.PRS_PLCU_I_CUN ON PRSDBM.PRS_LINEITEM_CONTRACTUTIL (CON_UTILIZATION_N) TABLESPACE S1_IDX;
CREATE INDEX PRSDBM.PRS_PLCU_I_LN ON PRSDBM.PRS_LINEITEM_CONTRACTUTIL (LINEITEM_N) TABLESPACE S1_IDX; 

/* ----------------------------------------------------------------------
TABLE: PRS_POLINEITEM_CONTRACTUTIL (New Table)
---------------------------------------------------------------------- */
CREATE TABLE PRS_POLINEITEM_CONTRACTUTIL (
    POLINEITEM_CONTRACT_N  VARCHAR2(11) NOT NULL,
    LINEITEM_N             VARCHAR2(11) NOT NULL,
    CON_UTILIZATION_N      VARCHAR2(11) NOT NULL
);

TABLESPACE PRS_DAT;

COMMENT ON TABLE PRSDBM.PRS_POLINEITEM_CONTRACTUTIL IS
    'This table maps the contract utilization amounts to the purchase order lineitem.';
COMMENT ON COLUMN PRSDBM.PRS_POLINEITEM_CONTRACTUTIL.POLINEITEM_CONTRACT_N IS
    'Primary key. Populated by Oracle Sequence.';
COMMENT ON COLUMN PRSDBM.PRS_POLINEITEM_CONTRACTUTIL.LINEITEM_N IS
    'Reference to the purchase order lineitem.';
COMMENT ON COLUMN PRSDBM.PRS_POLINEITEM_CONTRACTUTIL.CON_UTILIZATION_N IS
    'Reference to contract utilization.';

ALTER TABLE PRS_POLINEITEM_CONTRACTUTIL ADD CONSTRAINT PRS_POLICU_PK_PCN PRIMARY KEY ( POLINEITEM_CONTRACT_N )
  USING INDEX TABLESPACE PRS_IDX;

ALTER TABLE PRS_POLINEITEM_CONTRACTUTIL ADD CONSTRAINT PRS_POLC_FK_CULN FOREIGN KEY ( CON_UTILIZATION_N )
  REFERENCES PRS_CONTRACT_UTILIZATION ( CON_UTILIZATION_N );

ALTER TABLE PRS_POLINEITEM_CONTRACTUTIL ADD CONSTRAINT PRS_POLC_FK_LN FOREIGN KEY ( LINEITEM_N )
  REFERENCES PRS_PO_LINEITEM ( LINEITEM_N );

CREATE INDEX PRSDBM.PRS_POLCU_I_CUN ON PRSDBM.PRS_POLINEITEM_CONTRACTUTIL (CON_UTILIZATION_N) TABLESPACE S1_IDX;
CREATE INDEX PRSDBM.PRS_POLCU_I_LN ON PRSDBM.PRS_LINEITEM_CONTRACTUTIL (LINEITEM_N) TABLESPACE S1_IDX; 


/* ----------------------------------------------------------------------
TABLE: PRS_COLLECTION_CONTRACTUTIL (New Table)
---------------------------------------------------------------------- */

CREATE TABLE PRS_COLLECTION_CONTRACTUTIL (
    COLLECTION_CONTRACT_N  VARCHAR2(11) NOT NULL,
    COLLECT_N              VARCHAR2(11) NOT NULL,
    CON_UTILIZATION_N      VARCHAR2(11) NOT NULL
);

TABLESPACE PRS_DAT;

COMMENT ON TABLE PRSDBM.PRS_COLLECTION_CONTRACTUTIL IS
    'This table maps the contract utilization amounts to the collection in case of internal procurement';
COMMENT ON COLUMN PRSDBM.PRS_COLLECTION_CONTRACTUTIL.POLINEITEM_CONTRACT_N IS
    'Primary key. Populated by Oracle Sequence.';
COMMENT ON COLUMN PRSDBM.PRS_COLLECTION_CONTRACTUTIL.LINEITEM_N IS
    'Reference to the collection in case of internal procurement.';
COMMENT ON COLUMN PRSDBM.PRS_COLLECTION_CONTRACTUTIL.CON_UTILIZATION_N IS
    'Reference to contract utilization.';

ALTER TABLE PRS_COLLECTION_CONTRACTUTIL ADD CONSTRAINT PRS_PCCU_PK_CCN PRIMARY KEY ( COLLECTION_CONTRACT_N )
  USING INDEX TABLESPACE PRS_IDX;

ALTER TABLE PRS_COLLECTION_CONTRACTUTIL ADD CONSTRAINT PRS_PCC_FK_CN FOREIGN KEY ( COLLECT_N )
  REFERENCES PRS_COLLECTION ( COLLECT_N );

ALTER TABLE PRS_COLLECTION_CONTRACTUTIL ADD CONSTRAINT PRS_PCC_FK_CUN FOREIGN KEY ( CON_UTILIZATION_N )
  REFERENCES PRS_CONTRACT_UTILIZATION ( CON_UTILIZATION_N );


CREATE INDEX PRSDBM.PRS_PCCU_I_CUN ON PRSDBM.PRS_COLLECTION_CONTRACTUTIL (CON_UTILIZATION_N) TABLESPACE S1_IDX;
CREATE INDEX PRSDBM.PRS_PCCU_I_LN ON PRSDBM.PRS_COLLECTION_CONTRACTUTIL (COLLECT_N) TABLESPACE S1_IDX; 

  /* ----------------------------------------------------------------------
TABLE: PRS_PO_LINEITEM (New Column)
---------------------------------------------------------------------- */

ALTER TABLE PRSDBM.PRS_PO_LINEITEM
  ADD PR_LINEITEM_N VARCHAR2(11);

COMMENT ON COLUMN PRSDBM.PRS_PO_LINEITEM.PR_LINEITEM_N IS
  'Reference to the purchase request lineitem.';

ALTER TABLE PRS_PO_LINEITEM ADD CONSTRAINT PRS_PPOL_FK_PRLN FOREIGN KEY ( PR_LINEITEM_N )
  REFERENCES PRS_PURCHASE_LINEITEM ( LINEITEM_N );

CREATE INDEX PRSDBM.PRS_POLI_I_PRLN ON PRSDBM.PRS_PO_LINEITEM (PR_LINEITEM_N) TABLESPACE S1_IDX;

 /* ----------------------------------------------------------------------
TABLE: PRS_PO_LINEITEM (New Column)
---------------------------------------------------------------------- */

ALTER TABLE PRSDBM.PRS_PURCHASE_ORDER
  ADD CRCY_C VARCHAR2(11);

COMMENT ON COLUMN PRSDBM.PRS_PURCHASE_ORDER.CRCY_C IS
  'Currency Code. Reference to the currency table.';

ALTER TABLE PRS_PURCHASE_ORDER ADD CONSTRAINT PRS_PPO_FK_CC FOREIGN KEY ( CRCY_C ) 
  REFERENCES PRSCURRENCY ( CRCY_C );

CREATE INDEX PRSDBM.PRS_PO_I_CC ON PRSDBM.PRS_PURCHASE_ORDER (CRCY_C) TABLESPACE S1_IDX;

/* ----------------------------------------------------------------------
SEQUENCE
---------------------------------------------------------------------- */
CREATE SEQUENCE PRSDBM.PRS_CONTRACT_UTILIZATION_SEQ START WITH 1 MINVALUE 1 NOCACHE ORDER ;
CREATE SEQUENCE PRSDBM.PRS_LINEITEM_CONTRACTUTIL_SEQ START WITH 1 MINVALUE 1 NOCACHE ORDER ;
CREATE SEQUENCE PRSDBM.PRS_POLINEITEM_CONTRACTUTIL_SEQ START WITH 1 MINVALUE 1 NOCACHE ORDER ;
CREATE SEQUENCE PRSDBM.PRS_COLLECTION_CONTRACTUTIL_SEQ START WITH 1 MINVALUE 1 NOCACHE ORDER ;

/* ----------------------------------------------------------------------
GRANTS
---------------------------------------------------------------------- */
GRANT DELETE, INSERT, SELECT, UPDATE ON PRSDBM.PRS_CONTRACT_UTILIZATION TO PRJPRS;
GRANT SELECT ON PRSDBM.PRS_CONTRACT_UTILIZATION TO RPTPRS;
GRANT DELETE, INSERT, SELECT, UPDATE ON PRSDBM.PRS_LINEITEM_CONTRACTUTIL TO PRJPRS;
GRANT SELECT ON PRSDBM.PRS_LINEITEM_CONTRACTUTIL TO RPTPRS;
GRANT DELETE, INSERT, SELECT, UPDATE ON PRSDBM.PRS_POLINEITEM_CONTRACTUTIL TO PRJPRS;
GRANT SELECT ON PRSDBM.PRS_POLINEITEM_CONTRACTUTIL TO RPTPRS;
GRANT DELETE, INSERT, SELECT, UPDATE ON PRSDBM.PRS_COLLECTION_CONTRACTUTIL TO PRJPRS;
GRANT SELECT ON PRSDBM.PRS_COLLECTION_CONTRACTUTIL TO RPTPRS;

GRANT SELECT ON PRSDBM.PRS_CONTRACT_UTILIZATION_SEQ TO PRJPRS;
GRANT SELECT ON PRSDBM.PRS_LINEITEM_CONTRACTUTIL_SEQ TO RPTPRS;
GRANT SELECT ON PRSDBM.PRS_POLINEITEM_CONTRACTUTIL_SEQ TO PRJPRS;
GRANT SELECT ON PRSDBM.PRS_COLLECTION_CONTRACTUTIL_SEQ TO RPTPRS;

/* ----------------------------------------------------------------------
PUBLIC SYNONYM: Synonym name must be the same as the table name
---------------------------------------------------------------------- */
CREATE PUBLIC SYNONYM PRS_CONTRACT_UTILIZATION FOR PRSDBM.PRS_CONTRACT_UTILIZATION;
CREATE PUBLIC SYNONYM PRS_LINEITEM_CONTRACTUTIL FOR PRSDBM.PRS_LINEITEM_CONTRACTUTIL;
CREATE PUBLIC SYNONYM PRS_POLINEITEM_CONTRACTUTIL FOR PRSDBM.PRS_POLINEITEM_CONTRACTUTIL;
CREATE PUBLIC SYNONYM PRS_COLLECTION_CONTRACTUTIL FOR PRSDBM.PRS_COLLECTION_CONTRACTUTIL;

